---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Navigation from "../../components/Navigation.astro";
import Footer from "../../components/Footer.astro";
import FilterBar from "../../components/FilterBar.astro";
import BlogCard from "../../components/BlogCard.astro";
import PageHeader from "../../components/PageHeader.astro";
import ContentList from "../../components/ContentList.astro";
import { getCollection } from "astro:content";
import { getTagsByIds, type TagId } from "../../config/tags";

// Fetch and process blog posts
const allBlogPosts = await getCollection("blog");

const posts = allBlogPosts
  .map((post) => {
    // post.id is the filename without extension in Astro v5
    const slug = post.id;
    return {
      title: post.data.title,
      excerpt: post.data.excerpt,
      date: post.data.date,
      readTime: post.data.readTime,
      slug: slug,
      tags: post.data.tags as TagId[],
      // Parse date for sorting
      dateObj: new Date(post.data.date),
    };
  })
  .sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());

// Get all unique tags used in blog posts
const allTags = getTagsByIds([...new Set(posts.flatMap((p) => p.tags))]);

// Generate structured data for blog
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Blog",
  name: "Blog",
  description: "Thoughts on design, technology, and the creative process",
  url: new URL("/blog", Astro.site).toString(),
  blogPost: posts.slice(0, 10).map((post) => ({
    "@type": "BlogPosting",
    headline: post.title,
    description: post.excerpt,
    datePublished: post.date,
    url: new URL(`/blog/${post.slug}`, Astro.site).toString(),
  })),
};
---

<BaseLayout
  title="Blog â€” Design, Technology & Creative Process"
  description="Thoughts on design, technology, and the creative process"
>
  <Navigation currentPage="blog" />

  <PageHeader
    title="Blog"
    description="Thoughts on design, technology, and the creative process"
  />

  <FilterBar tags={allTags} type="blog" />

  <ContentList>
    {
      posts.map((post, i) => (
        <div
          data-blog-item
          data-blog-tags={post.tags.join(",")}
          class:list={[i === posts.length - 1 && "border-b-0"]}
        >
          <BlogCard
            title={post.title}
            excerpt={post.excerpt}
            date={post.date}
            readTime={post.readTime}
            slug={post.slug}
            tags={post.tags}
            variant="list"
          />
        </div>
      ))
    }
  </ContentList>

  <Footer />

  <!-- Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />
</BaseLayout>

<style>
  /* Ensure smooth filtering animations */
  @media (prefers-reduced-motion: no-preference) {
    [data-blog-item] {
      transition: opacity 0.2s ease-in-out;
    }
  }
</style>
