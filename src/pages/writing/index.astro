---
/**
 * Writing Index Page
 * 
 * Lists all blog posts with filtering capabilities.
 * Features:
 * - Tag-based filtering
 * - Structured data for SEO
 * - Responsive grid layout
 */

import BaseLayout from "../../layouts/BaseLayout.astro";
import Navigation from "../../components/Navigation.astro";
import Footer from "../../components/Footer.astro";
import FilterBar from "../../components/FilterBar.astro";
import BlogCard from "../../components/BlogCard.astro";
import PageHeader from "../../components/PageHeader.astro";
import ContentList from "../../components/ContentList.astro";
import { getCollection } from "astro:content";
import { getTagsByIds, type TagId } from "../../config/tags";
import { PAGE_IDS } from "../../utils/constants";

/**
 * Fetch and process all writing posts
 */
const allWritingPosts = await getCollection("writing");

/**
 * Transform and sort posts by date (newest first)
 */
const posts = allWritingPosts
  .map((post) => {
    const slug = post.id; // In Astro 5, post.id is the filename without extension
    return {
      title: post.data.title,
      excerpt: post.data.excerpt,
      date: post.data.date,
      readTime: post.data.readTime,
      slug: slug,
      tags: post.data.tags as TagId[],
      dateObj: new Date(post.data.date), // For sorting
    };
  })
  .sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());

/**
 * Get all unique tags used across all posts
 */
const allTags = getTagsByIds([...new Set(posts.flatMap((p) => p.tags))]);

/**
 * Generate structured data for SEO
 */
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Blog",
  name: "Writing",
  description: "Thoughts on design, technology, and the creative process",
  url: new URL("/writing", Astro.site).toString(),
  blogPost: posts.slice(0, 10).map((post) => ({
    "@type": "BlogPosting",
    headline: post.title,
    description: post.excerpt,
    datePublished: post.date,
    url: new URL(`/writing/${post.slug}`, Astro.site).toString(),
  })),
};
---

<BaseLayout
  title="Writing â€” Design, Technology & Creative Process"
  description="Thoughts on design, technology, and the creative process"
>
  <Navigation currentPage={PAGE_IDS.WRITING} />

  <PageHeader
    title="Writing"
    description="Thoughts on design, technology, and the creative process"
  />

  <FilterBar tags={allTags} type="writing" />

  <ContentList>
    {
      posts.map((post, i) => (
        <div
          data-writing-item
          data-writing-tags={post.tags.join(",")}
          class:list={[i === posts.length - 1 && "border-b-0"]}
        >
          <BlogCard
            title={post.title}
            excerpt={post.excerpt}
            date={post.date}
            readTime={post.readTime}
            slug={post.slug}
            tags={post.tags}
            variant="list"
          />
        </div>
      ))
    }
  </ContentList>

  <Footer />

  <!-- Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />
</BaseLayout>

<style>
  /* Ensure smooth filtering animations */
  @media (prefers-reduced-motion: no-preference) {
    [data-writing-item] {
      transition: opacity 0.2s ease;
    }
  }
</style>
