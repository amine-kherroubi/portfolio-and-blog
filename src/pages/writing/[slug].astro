---
/**
 * Writing Post Page - Desktop Only (Refactored)
 *
 * Now uses shared analytics utilities for social sharing
 * and article read tracking.
 */

import BaseLayout from "../../layouts/BaseLayout.astro";
import Navigation from "../../components/Navigation.astro";
import Footer from "../../components/Footer.astro";
import ArticleSchema from "../../components/ArticleSchema.astro";
import { getCollection, render, type CollectionEntry } from "astro:content";
import { SITE } from "../../config/site.config";

export async function getStaticPaths() {
  const writingPosts = await getCollection("writing");
  return writingPosts.map((post: CollectionEntry<"writing">) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

type Props = {
  post: CollectionEntry<"writing">;
};

const { post } = Astro.props as Props;
const { Content } = await render(post);

/**
 * Format ISO date for display (YYYY-MM-DD only)
 * Input: "2024-12-11T00:00:00.000Z"
 * Output: "2024-12-11"
 */
function formatDisplayDate(isoDateStr: string): string {
  try {
    return isoDateStr.split("T")[0] || isoDateStr;
  } catch (error) {
    console.warn("[WritingPost] Date formatting failed:", error);
    return isoDateStr;
  }
}

const displayDate = formatDisplayDate(post.data.date);
const postUrl = new URL(`/writing/${post.id}`, Astro.site || Astro.url.origin);

// Keep full ISO format for schema
const publishDate = post.data.date;
---

<BaseLayout
  title={post.data.title}
  description={post.data.excerpt}
  type="article"
  author={SITE.name}
  publishedTime={publishDate}
  keywords={post.data.tags}
>
  <div slot="header" data-pagefind-ignore>
    <Navigation currentPage="writing" />
  </div>

  <article
    id="main-content"
    class="py-24 px-8"
    itemscope
    itemtype="https://schema.org/BlogPosting"
  >
    <div data-pagefind-body>
      <!-- Metadata for Pagefind -->
      <h1 data-pagefind-meta="title" class="sr-only">{post.data.title}</h1>
      <p data-pagefind-meta="description" class="sr-only">
        {post.data.excerpt}
      </p>
      <time data-pagefind-meta="date" class="sr-only">{displayDate}</time>
      {
        post.data.tags.map((tag: string) => (
          <span data-pagefind-meta="tags" class="sr-only">
            {tag}
          </span>
        ))
      }

      <div class="max-w-container mx-auto">
        <header class="mb-32">
          <div
            class="flex items-center gap-4 text-sm font-bold uppercase tracking-[0.15em] mb-16 text-black/50"
          >
            <time datetime={publishDate} itemprop="datePublished"
              >{displayDate}</time
            >
            <span class="w-2 h-2 bg-black" aria-hidden="true"></span>
            <span itemprop="timeRequired">{post.data.readTime}</span>
            <span class="w-2 h-2 bg-black" aria-hidden="true"></span>
            <span
              itemprop="author"
              itemscope
              itemtype="https://schema.org/Person"
            >
              <span itemprop="name">{SITE.name}</span>
            </span>
          </div>

          <h2
            class="text-7xl font-bold leading-[1.1] tracking-[-0.02em] mb-16"
            itemprop="headline"
          >
            {post.data.title}
          </h2>

          <p
            class="text-2xl leading-relaxed font-light text-black/70 max-w-3xl mb-16"
            itemprop="description"
          >
            {post.data.excerpt}
          </p>

          <!-- Social Share Buttons -->
          <div
            class="flex items-center gap-4"
            role="group"
            aria-label="Share this article"
            data-pagefind-ignore
          >
            <span
              class="text-sm font-bold uppercase tracking-[0.15em] text-black/50"
            >
              Share:
            </span>
            <button
              class="share-button text-sm font-bold uppercase tracking-[0.15em] hover:opacity-50 transition-opacity duration-200 focus-visible:opacity-50"
              data-share="twitter"
              aria-label="Share on Twitter"
            >
              Twitter
            </button>
            <button
              class="share-button text-sm font-bold uppercase tracking-[0.15em] hover:opacity-50 transition-opacity duration-200 focus-visible:opacity-50"
              data-share="linkedin"
              aria-label="Share on LinkedIn"
            >
              LinkedIn
            </button>
            <button
              class="share-button text-sm font-bold uppercase tracking-[0.15em] hover:opacity-50 transition-opacity duration-200 focus-visible:opacity-50"
              data-share="copy"
              aria-label="Copy link"
            >
              Copy Link
            </button>
          </div>

          <meta itemprop="url" content={postUrl.toString()} />
        </header>

        <div class="prose prose-lg max-w-none" itemprop="articleBody">
          <Content />
        </div>

        <footer
          class="mt-32 pt-16 border-t-2 border-black"
          data-pagefind-ignore
        >
          <div class="flex items-center justify-between">
            <a
              href="/writing"
              class="inline-flex items-center gap-3 text-sm font-bold uppercase tracking-[0.15em] hover:opacity-50 transition-opacity duration-200 focus-visible:opacity-50"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="2"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="square"
                  stroke-linejoin="miter"
                  d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
              </svg>
              All Posts
            </a>
          </div>
        </footer>
      </div>
    </div>
  </article>

  <div slot="footer" data-pagefind-ignore>
    <Footer />
  </div>

  <ArticleSchema
    slot="head"
    title={post.data.title}
    description={post.data.excerpt}
    datePublished={publishDate}
    author={SITE.name}
    url={postUrl}
    keywords={post.data.tags}
  />
</BaseLayout>

<script>
  /**
   * Social Share and Article Tracking with Shared Utilities
   */

  import {
    trackShareClick,
    trackArticleRead,
    trackPageView,
  } from "@/utils/use-analytics";
  import { querySelector } from "@/utils/use-dom-utils";

  function initArticlePage() {
    const articleTitle =
      querySelector<HTMLHeadingElement>('h2[itemprop="headline"]')
        ?.textContent || "";

    // Track page view
    trackPageView({
      title: articleTitle,
      path: window.location.pathname,
      referrer: document.referrer,
    });

    // Initialize social sharing
    initSocialShare(articleTitle);

    // Track article reading progress
    initReadingProgress(articleTitle);
  }

  /**
   * Social share functionality
   */
  function initSocialShare(articleTitle: string) {
    const shareButtons = document.querySelectorAll(".share-button");
    const currentUrl = window.location.href;

    shareButtons.forEach((button) => {
      button.addEventListener("click", async () => {
        const shareType = button.getAttribute("data-share");

        try {
          switch (shareType) {
            case "twitter":
              trackShareClick("twitter", articleTitle);
              window.open(
                `https://twitter.com/intent/tweet?url=${encodeURIComponent(currentUrl)}&text=${encodeURIComponent(articleTitle)}`,
                "_blank",
                "width=550,height=420"
              );
              break;

            case "linkedin":
              trackShareClick("linkedin", articleTitle);
              window.open(
                `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(currentUrl)}`,
                "_blank",
                "width=550,height=420"
              );
              break;

            case "copy":
              await navigator.clipboard.writeText(currentUrl);
              trackShareClick("copy", articleTitle);
              const originalText = button.textContent;
              button.textContent = "Copied!";
              setTimeout(() => {
                button.textContent = originalText;
              }, 2000);
              break;
          }
        } catch (error) {
          console.error("[Article] Share error:", error);
        }
      });
    });
  }

  /**
   * Track reading progress
   */
  function initReadingProgress(articleTitle: string) {
    let hasTracked50 = false;
    let hasTracked90 = false;

    const trackProgress = () => {
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollTop = window.scrollY;
      const scrollPercentage =
        (scrollTop / (documentHeight - windowHeight)) * 100;

      if (scrollPercentage >= 50 && !hasTracked50) {
        hasTracked50 = true;
        trackArticleRead(articleTitle, 50);
      }

      if (scrollPercentage >= 90 && !hasTracked90) {
        hasTracked90 = true;
        trackArticleRead(articleTitle, 90);
      }
    };

    // Throttle scroll events
    let ticking = false;
    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          trackProgress();
          ticking = false;
        });
        ticking = true;
      }
    });
  }

  // Initialize on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initArticlePage);
  } else {
    initArticlePage();
  }

  // Reinitialize on Astro page navigation
  document.addEventListener("astro:page-load", initArticlePage);
</script>

<style>
  @media (prefers-reduced-motion: no-preference) {
    article {
      animation: fadeInUp 0.4s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  }
</style>
