---
import Tag from "./Tag.astro";
import type { Tag as TagType } from "../config/tags";

interface Props {
  tags: TagType[];
  type: "blog" | "portfolio";
}

const { tags, type } = Astro.props;

const sortedTags = [...tags].sort((a, b) =>
  a.category === b.category
    ? a.label.localeCompare(b.label)
    : a.category.localeCompare(b.category)
);
---

<div
  class="filter-bar border-b-2 border-black bg-white/95 backdrop-blur-sm sticky top-20 md:top-24 z-40"
  role="search"
  aria-label="Filter content"
>
  <div
    class="max-w-screen-2xl mx-auto px-8 md:px-16 lg:px-20 xl:px-32 py-6 md:py-8 lg:py-12"
  >
    <div
      class="flex flex-col sm:flex-row items-start sm:items-center gap-4 md:gap-6 mb-6 md:mb-8"
    >
      <span
        class="text-xs md:text-sm font-bold uppercase tracking-[0.15em] text-black/50"
        id={`${type}-filter-label`}
      >
        Filter by:
      </span>
      <button
        id={`${type}-clear-filters`}
        class="text-xs md:text-sm font-bold uppercase tracking-[0.15em] hover:opacity-50 transition-opacity duration-200 focus-visible:opacity-50 hidden"
        aria-label="Clear all filters"
      >
        Clear All
      </button>
    </div>

    <div
      class="flex flex-wrap gap-2 md:gap-3"
      id={`${type}-filter-tags`}
      role="group"
      aria-labelledby={`${type}-filter-label`}
    >
      {
        sortedTags.map((tag) => (
          <button
            class="filter-tag-btn focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-black focus-visible:ring-offset-2"
            data-tag-id={tag.id}
            data-type={type}
            aria-pressed="false"
            aria-label={`Filter by ${tag.label}`}
          >
            <Tag label={tag.label} variant="filter" clickable={true} />
          </button>
        ))
      }
    </div>

    <div
      id={`${type}-results-count`}
      class="mt-6 md:mt-8 text-xs md:text-sm text-black/60 font-bold uppercase tracking-[0.15em]"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    >
    </div>
  </div>
</div>

<script>
  function initializeFilters(type: "blog" | "portfolio") {
    const filterTags = document.getElementById(`${type}-filter-tags`);
    const clearBtn = document.getElementById(`${type}-clear-filters`);
    const resultsCount = document.getElementById(`${type}-results-count`);
    const items = document.querySelectorAll(`[data-${type}-item]`);

    if (!filterTags || !clearBtn || !resultsCount || !items.length) return;

    const activeFilters = new Set<string>();

    // Initialize from URL
    const urlParams = new URLSearchParams(window.location.search);
    const tagsParam = urlParams.get("tags");
    if (tagsParam) {
      tagsParam.split(",").forEach((tag) => activeFilters.add(tag));
      updateUI();
      filterItems();
    } else {
      updateResultsCount(items.length);
    }

    // Event listeners with keyboard support
    filterTags.addEventListener("click", handleFilterClick);
    filterTags.addEventListener("keydown", handleKeyDown);
    clearBtn.addEventListener("click", clearAllFilters);

    function handleFilterClick(e: Event) {
      const btn = (e.target as HTMLElement).closest(
        ".filter-tag-btn"
      ) as HTMLButtonElement;
      if (!btn?.dataset.tagId) return;

      toggleFilter(btn.dataset.tagId);
    }

    function handleKeyDown(e: KeyboardEvent) {
      const btn = (e.target as HTMLElement).closest(
        ".filter-tag-btn"
      ) as HTMLButtonElement;
      if (!btn?.dataset.tagId) return;

      // Handle Enter and Space keys
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        toggleFilter(btn.dataset.tagId);
      }
    }

    function toggleFilter(tagId: string) {
      activeFilters.has(tagId)
        ? activeFilters.delete(tagId)
        : activeFilters.add(tagId);

      updateUI();
      filterItems();
      updateURL();
    }

    function clearAllFilters() {
      activeFilters.clear();
      updateUI();
      filterItems();
      updateURL();
    }

    function updateUI() {
      filterTags.querySelectorAll(".filter-tag-btn").forEach((btn) => {
        const tagId = (btn as HTMLButtonElement).dataset.tagId;
        const tag = btn.querySelector("[data-tag]");
        const isActive = tagId && activeFilters.has(tagId);

        // Update ARIA state
        btn.setAttribute("aria-pressed", String(isActive));

        // Update visual state
        tag?.classList.toggle("bg-black", isActive);
        tag?.classList.toggle("text-white", isActive);
        tag?.classList.toggle("bg-white", !isActive);
        tag?.classList.toggle("text-black", !isActive);
      });

      clearBtn.classList.toggle("hidden", activeFilters.size === 0);
    }

    function filterItems() {
      let visibleCount = 0;
      const hasFilters = activeFilters.size > 0;

      // Use requestAnimationFrame for smooth updates
      requestAnimationFrame(() => {
        items.forEach((item) => {
          const itemTags =
            (item as HTMLElement).dataset[`${type}Tags`]
              ?.split(",")
              .map((t) => t.trim()) || [];
          const isVisible =
            !hasFilters || itemTags.some((tag) => activeFilters.has(tag));

          (item as HTMLElement).style.display = isVisible ? "" : "none";
          if (isVisible) visibleCount++;
        });

        updateResultsCount(visibleCount);
      });
    }

    function updateResultsCount(count: number) {
      const total = items.length;
      const typeLabel = type === "blog" ? "posts" : "projects";
      resultsCount.textContent =
        activeFilters.size > 0
          ? `Showing ${count} of ${total} ${typeLabel}`
          : `${total} ${typeLabel} total`;
    }

    function updateURL() {
      const url = new URL(window.location.href);
      activeFilters.size > 0
        ? url.searchParams.set("tags", Array.from(activeFilters).join(","))
        : url.searchParams.delete("tags");

      // Use replaceState to avoid adding history entries
      window.history.replaceState({}, "", url);
    }
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  function init() {
    const path = window.location.pathname;
    if (path.includes("/blog")) initializeFilters("blog");
    else if (path.includes("/portfolio")) initializeFilters("portfolio");
  }

  // Reinitialize on page navigation (for View Transitions)
  document.addEventListener("astro:page-load", init);
</script>

<style>
  /* Smooth animations */
  @media (prefers-reduced-motion: no-preference) {
    .filter-tag-btn [data-tag] {
      transition:
        background-color 0.2s ease,
        color 0.2s ease;
    }

    [data-blog-item],
    [data-portfolio-item] {
      transition: opacity 0.2s ease;
    }
  }

  /* Loading state */
  [data-blog-item][style*="display: none"],
  [data-portfolio-item][style*="display: none"] {
    opacity: 0;
  }
</style>
