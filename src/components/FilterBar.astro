---
import Tag from "./Tag.astro";
import type { Tag as TagType } from "../config/tags";

interface Props {
  tags: TagType[];
  type: "blog" | "portfolio";
}

const { tags, type } = Astro.props;

const sortedTags = [...tags].sort((a, b) =>
  a.category === b.category
    ? a.label.localeCompare(b.label)
    : a.category.localeCompare(b.category)
);
---

<div class="filter-bar border-b-2 border-black bg-white sticky top-0 z-10">
  <div class="max-w-screen-2xl mx-auto px-32 py-12">
    <div class="flex items-center gap-8 mb-8">
      <span class="text-sm font-bold uppercase tracking-widest text-black/50">
        Filter by:
      </span>
      <button
        id={`${type}-clear-filters`}
        class="text-sm font-bold uppercase tracking-widest hover:opacity-50 transition-opacity hidden"
      >
        Clear All
      </button>
    </div>
    <div class="flex flex-wrap gap-4" id={`${type}-filter-tags`}>
      {
        sortedTags.map((tag) => (
          <button class="filter-tag-btn" data-tag-id={tag.id} data-type={type}>
            <Tag label={tag.label} variant="filter" clickable={true} />
          </button>
        ))
      }
    </div>
    <div
      id={`${type}-results-count`}
      class="mt-8 text-sm text-black/60 font-bold uppercase tracking-widest"
    >
    </div>
  </div>
</div>

<script>
  function initializeFilters(type: "blog" | "portfolio") {
    const filterTags = document.getElementById(`${type}-filter-tags`);
    const clearBtn = document.getElementById(`${type}-clear-filters`);
    const resultsCount = document.getElementById(`${type}-results-count`);
    const items = document.querySelectorAll(`[data-${type}-item]`);

    if (!filterTags || !clearBtn || !resultsCount || !items.length) return;

    const activeFilters = new Set<string>();

    // Initialize from URL
    const urlParams = new URLSearchParams(window.location.search);
    const tagsParam = urlParams.get("tags");
    if (tagsParam) {
      tagsParam.split(",").forEach((tag) => activeFilters.add(tag));
      updateUI();
      filterItems();
    } else {
      updateResultsCount(items.length);
    }

    // Event listeners
    filterTags.addEventListener("click", (e) => {
      const btn = (e.target as HTMLElement).closest(
        ".filter-tag-btn"
      ) as HTMLButtonElement;
      if (!btn?.dataset.tagId) return;

      const tagId = btn.dataset.tagId;
      activeFilters.has(tagId)
        ? activeFilters.delete(tagId)
        : activeFilters.add(tagId);

      updateUI();
      filterItems();
      updateURL();
    });

    clearBtn.addEventListener("click", () => {
      activeFilters.clear();
      updateUI();
      filterItems();
      updateURL();
    });

    function updateUI() {
      filterTags.querySelectorAll(".filter-tag-btn").forEach((btn) => {
        const tagId = (btn as HTMLButtonElement).dataset.tagId;
        const tag = btn.querySelector("[data-tag]");
        const isActive = tagId && activeFilters.has(tagId);

        tag?.classList.toggle("bg-black", isActive);
        tag?.classList.toggle("text-white", isActive);
        tag?.classList.toggle("bg-white", !isActive);
        tag?.classList.toggle("text-black", !isActive);
      });

      clearBtn.classList.toggle("hidden", activeFilters.size === 0);
    }

    function filterItems() {
      let visibleCount = 0;
      const hasFilters = activeFilters.size > 0;

      items.forEach((item) => {
        const itemTags =
          (item as HTMLElement).dataset[`${type}Tags`]
            ?.split(",")
            .map((t) => t.trim()) || [];
        const isVisible =
          !hasFilters || itemTags.some((tag) => activeFilters.has(tag));

        (item as HTMLElement).style.display = isVisible ? "" : "none";
        if (isVisible) visibleCount++;
      });

      updateResultsCount(visibleCount);
    }

    function updateResultsCount(count: number) {
      const total = items.length;
      const typeLabel = type === "blog" ? "posts" : "projects";
      resultsCount.textContent =
        activeFilters.size > 0
          ? `Showing ${count} of ${total} ${typeLabel}`
          : `${total} ${typeLabel} total`;
    }

    function updateURL() {
      const url = new URL(window.location.href);
      activeFilters.size > 0
        ? url.searchParams.set("tags", Array.from(activeFilters).join(","))
        : url.searchParams.delete("tags");
      window.history.replaceState({}, "", url);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const path = window.location.pathname;
    if (path.includes("/blog")) initializeFilters("blog");
    else if (path.includes("/portfolio")) initializeFilters("portfolio");
  });
</script>
