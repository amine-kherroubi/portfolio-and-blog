---
import Tag from "./Tag.astro";
import type { Tag as TagType } from "../config/tags";

interface Props {
  tags: TagType[];
  type: "blog" | "portfolio";
}

const { tags, type } = Astro.props;

// Sort tags by category and then by label
const sortedTags = [...tags].sort((a, b) => {
  if (a.category !== b.category) {
    return a.category.localeCompare(b.category);
  }
  return a.label.localeCompare(b.label);
});
---

<div class="filter-bar border-b-2 border-black bg-white sticky top-0 z-10">
  <div class="max-w-[1400px] mx-auto px-8 md:px-16 lg:px-20 xl:px-32 py-8">
    <div class="flex items-center gap-6 mb-6">
      <span
        class="text-[0.8125rem] font-bold uppercase tracking-[0.15em] text-black/50"
      >
        Filter by:
      </span>
      <button
        id={`${type}-clear-filters`}
        class="text-[0.8125rem] font-bold uppercase tracking-[0.15em] hover:opacity-50 transition-opacity duration-200 hidden"
      >
        Clear All
      </button>
    </div>
    <div class="flex flex-wrap gap-3" id={`${type}-filter-tags`}>
      {
        sortedTags.map((tag) => (
          <button class="filter-tag-btn" data-tag-id={tag.id} data-type={type}>
            <Tag label={tag.label} variant="filter" clickable={true} />
          </button>
        ))
      }
    </div>
    <div
      id={`${type}-results-count`}
      class="mt-6 text-sm text-black/60 font-bold uppercase tracking-[0.15em]"
    >
      <!-- Results count will be inserted here -->
    </div>
  </div>
</div>

<script>
  function initializeFilters(type: "blog" | "portfolio") {
    const filterTags = document.getElementById(`${type}-filter-tags`);
    const clearBtn = document.getElementById(`${type}-clear-filters`);
    const resultsCount = document.getElementById(`${type}-results-count`);
    const items = document.querySelectorAll(`[data-${type}-item]`);

    if (!filterTags || !clearBtn || !resultsCount) return;

    let activeFilters = new Set<string>();

    // Get filters from URL on load
    const urlParams = new URLSearchParams(window.location.search);
    const tagsParam = urlParams.get("tags");
    if (tagsParam) {
      activeFilters = new Set(tagsParam.split(","));
      updateUI();
      filterItems();
    } else {
      updateResultsCount(items.length);
    }

    // Handle filter button clicks
    filterTags.addEventListener("click", (e) => {
      const btn = (e.target as HTMLElement).closest(
        ".filter-tag-btn"
      ) as HTMLButtonElement;
      if (!btn) return;

      const tagId = btn.dataset.tagId;
      if (!tagId) return;

      if (activeFilters.has(tagId)) {
        activeFilters.delete(tagId);
      } else {
        activeFilters.add(tagId);
      }

      updateUI();
      filterItems();
      updateURL();
    });

    // Handle clear button
    clearBtn.addEventListener("click", () => {
      activeFilters.clear();
      updateUI();
      filterItems();
      updateURL();
    });

    function updateUI() {
      // Update button states
      const buttons = filterTags.querySelectorAll(".filter-tag-btn");
      buttons.forEach((btn) => {
        const tagId = (btn as HTMLButtonElement).dataset.tagId;
        const tag = btn.querySelector("[data-tag]");
        if (tagId && activeFilters.has(tagId)) {
          tag?.classList.add("bg-black", "text-white");
          tag?.classList.remove("bg-white", "text-black");
        } else {
          tag?.classList.remove("bg-black", "text-white");
          tag?.classList.add("bg-white", "text-black");
        }
      });

      // Show/hide clear button
      if (activeFilters.size > 0) {
        clearBtn.classList.remove("hidden");
      } else {
        clearBtn.classList.add("hidden");
      }
    }

    function filterItems() {
      let visibleCount = 0;

      items.forEach((item) => {
        const itemTags =
          (item as HTMLElement).dataset[`${type}Tags`]?.split(",") || [];

        if (activeFilters.size === 0) {
          // No filters active, show all
          (item as HTMLElement).style.display = "";
          visibleCount++;
        } else {
          // Check if item has any of the active tags
          const hasMatchingTag = itemTags.some((tag) =>
            activeFilters.has(tag.trim())
          );
          if (hasMatchingTag) {
            (item as HTMLElement).style.display = "";
            visibleCount++;
          } else {
            (item as HTMLElement).style.display = "none";
          }
        }
      });

      updateResultsCount(visibleCount);
    }

    function updateResultsCount(count: number) {
      if (resultsCount) {
        resultsCount.textContent =
          activeFilters.size > 0
            ? `Showing ${count} of ${items.length} ${type === "blog" ? "posts" : "projects"}`
            : `${items.length} ${type === "blog" ? "posts" : "projects"} total`;
      }
    }

    function updateURL() {
      const url = new URL(window.location.href);
      if (activeFilters.size > 0) {
        url.searchParams.set("tags", Array.from(activeFilters).join(","));
      } else {
        url.searchParams.delete("tags");
      }
      window.history.replaceState({}, "", url);
    }
  }

  // Initialize filters when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    const path = window.location.pathname;
    if (path.includes("/blog")) {
      initializeFilters("blog");
    } else if (path.includes("/portfolio")) {
      initializeFilters("portfolio");
    }
  });
</script>
