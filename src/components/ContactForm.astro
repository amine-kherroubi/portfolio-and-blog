---
/**
 * ContactForm Component - Desktop Only
 *
 * Purpose: Let visitors send messages or inquiries.
 * Implementation: HTML form with fields (name, email, message) and <label> for each input.
 * Includes client-side validation and ARIA error messaging.
 *
 * Justification: A clear contact form converts interest into action. Accessibility requires
 * each field have an accessible name (label). Providing inline error feedback via ARIA
 * ensures all users can correct mistakes.
 */

interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<section class:list={["py-24 px-8 border-t-2 border-black", className]}>
  <div class="max-w-container mx-auto">
    <div class="grid grid-cols-12 gap-12">
      <div class="col-span-4">
        <h2 class="text-3xl font-bold leading-[1.1] tracking-[-0.02em] mb-6">
          Get in Touch
        </h2>
        <p class="text-base leading-relaxed text-black/70">
          Have a project in mind? Let's discuss how we can work together.
        </p>
      </div>

      <div class="col-span-8">
        <form
          id="contact-form"
          class="space-y-8"
          novalidate
          aria-label="Contact form"
        >
          <!-- Name Field -->
          <div class="form-field">
            <label
              for="name"
              class="block text-sm font-bold uppercase tracking-[0.15em] mb-3"
            >
              Name <span class="text-black/50" aria-label="required">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              aria-required="true"
              aria-describedby="name-error"
              class="w-full border-2 border-black px-5 py-3 text-base focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 transition-shadow duration-200"
              placeholder="Your name"
            />
            <div
              id="name-error"
              class="error-message mt-2 text-sm text-black hidden"
              role="alert"
              aria-live="polite"
            >
            </div>
          </div>

          <!-- Email Field -->
          <div class="form-field">
            <label
              for="email"
              class="block text-sm font-bold uppercase tracking-[0.15em] mb-3"
            >
              Email <span class="text-black/50" aria-label="required">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              aria-required="true"
              aria-describedby="email-error"
              class="w-full border-2 border-black px-5 py-3 text-base focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 transition-shadow duration-200"
              placeholder="your@email.com"
            />
            <div
              id="email-error"
              class="error-message mt-2 text-sm text-black hidden"
              role="alert"
              aria-live="polite"
            >
            </div>
          </div>

          <!-- Message Field -->
          <div class="form-field">
            <label
              for="message"
              class="block text-sm font-bold uppercase tracking-[0.15em] mb-3"
            >
              Message <span class="text-black/50" aria-label="required">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              required
              aria-required="true"
              aria-describedby="message-error"
              rows="6"
              class="w-full border-2 border-black px-5 py-3 text-base resize-y focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 transition-shadow duration-200"
              placeholder="Tell me about your project..."></textarea>
            <div
              id="message-error"
              class="error-message mt-2 text-sm text-black hidden"
              role="alert"
              aria-live="polite"
            >
            </div>
          </div>

          <!-- Submit Button -->
          <div class="flex items-center gap-6">
            <button
              type="submit"
              class="inline-flex items-center gap-3 bg-black text-white border-2 border-black px-8 py-4 text-sm font-bold uppercase tracking-[0.15em] hover:bg-white hover:text-black transition-colors duration-200 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label="Send message"
            >
              Send Message
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="2"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="square"
                  stroke-linejoin="miter"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
              </svg>
            </button>

            <!-- Status Message -->
            <div
              id="form-status"
              class="text-sm font-bold uppercase tracking-[0.15em] hidden"
              role="status"
              aria-live="polite"
            >
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  /**
   * Contact Form Validation and Submission
   *
   * Implements client-side validation with ARIA error messaging
   * for accessibility and user feedback.
   */

  function initContactForm() {
    const form = document.getElementById(
      "contact-form"
    ) as HTMLFormElement | null;
    if (!form) return;

    const nameInput = form.querySelector("#name") as HTMLInputElement;
    const emailInput = form.querySelector("#email") as HTMLInputElement;
    const messageInput = form.querySelector("#message") as HTMLTextAreaElement;
    const submitButton = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;
    const formStatus = document.getElementById("form-status");

    /**
     * Validate a single field
     */
    function validateField(
      input: HTMLInputElement | HTMLTextAreaElement
    ): boolean {
      const errorDiv = document.getElementById(
        `${input.id}-error`
      ) as HTMLElement;
      let isValid = true;
      let errorMessage = "";

      // Check if field is empty
      if (!input.value.trim()) {
        isValid = false;
        errorMessage = "This field is required";
      }
      // Additional email validation
      else if (input.type === "email") {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(input.value)) {
          isValid = false;
          errorMessage = "Please enter a valid email address";
        }
      }
      // Message minimum length
      else if (input.id === "message" && input.value.trim().length < 10) {
        isValid = false;
        errorMessage = "Message must be at least 10 characters";
      }

      // Update ARIA and visual state
      if (!isValid) {
        input.setAttribute("aria-invalid", "true");
        input.classList.add("border-red-500");
        errorDiv.textContent = errorMessage;
        errorDiv.classList.remove("hidden");
      } else {
        input.setAttribute("aria-invalid", "false");
        input.classList.remove("border-red-500");
        errorDiv.textContent = "";
        errorDiv.classList.add("hidden");
      }

      return isValid;
    }

    /**
     * Validate all fields
     */
    function validateForm(): boolean {
      const nameValid = validateField(nameInput);
      const emailValid = validateField(emailInput);
      const messageValid = validateField(messageInput);

      return nameValid && emailValid && messageValid;
    }

    /**
     * Show form status message
     */
    function showStatus(message: string, isError: boolean = false) {
      if (!formStatus) return;

      formStatus.textContent = message;
      formStatus.classList.remove("hidden", "text-black", "text-red-600");
      formStatus.classList.add(isError ? "text-red-600" : "text-black");
    }

    /**
     * Hide form status message
     */
    function hideStatus() {
      if (!formStatus) return;
      formStatus.classList.add("hidden");
      formStatus.textContent = "";
    }

    // Real-time validation on blur
    [nameInput, emailInput, messageInput].forEach((input) => {
      input.addEventListener("blur", () => {
        if (input.value.trim()) {
          validateField(input);
        }
      });

      // Clear error on input
      input.addEventListener("input", () => {
        if (input.getAttribute("aria-invalid") === "true") {
          validateField(input);
        }
      });
    });

    /**
     * Handle form submission
     */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideStatus();

      // Validate all fields
      if (!validateForm()) {
        showStatus("Please correct the errors above", true);
        // Focus first invalid field
        const firstInvalid = form.querySelector(
          '[aria-invalid="true"]'
        ) as HTMLElement;
        firstInvalid?.focus();
        return;
      }

      // Disable submit button during submission
      submitButton.disabled = true;
      showStatus("Sending...");

      try {
        // Collect form data
        const formData = {
          name: nameInput.value.trim(),
          email: emailInput.value.trim(),
          message: messageInput.value.trim(),
          timestamp: new Date().toISOString(),
        };

        // TODO: Replace with your actual endpoint
        // Example: await fetch('/api/contact', { method: 'POST', body: JSON.stringify(formData) })

        // Simulate API call
        await new Promise((resolve) => setTimeout(resolve, 1000));

        // Success - For demo purposes, log to console
        console.log("Form submitted:", formData);

        // Show success message
        showStatus("Message sent successfully!");

        // Reset form
        form.reset();

        // Clear any validation states
        [nameInput, emailInput, messageInput].forEach((input) => {
          input.removeAttribute("aria-invalid");
          input.classList.remove("border-red-500");
          const errorDiv = document.getElementById(`${input.id}-error`);
          if (errorDiv) {
            errorDiv.textContent = "";
            errorDiv.classList.add("hidden");
          }
        });

        // Hide success message after 5 seconds
        setTimeout(() => {
          hideStatus();
        }, 5000);
      } catch (error) {
        console.error("Form submission error:", error);
        showStatus("Failed to send message. Please try again.", true);
      } finally {
        submitButton.disabled = false;
      }
    });
  }

  // Initialize on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initContactForm);
  } else {
    initContactForm();
  }

  // Reinitialize on Astro page navigation
  document.addEventListener("astro:page-load", initContactForm);
</script>

<style>
  .form-field input[aria-invalid="true"],
  .form-field textarea[aria-invalid="true"] {
    border-color: #dc2626;
  }

  .error-message {
    font-weight: 600;
  }

  @media (prefers-reduced-motion: no-preference) {
    .form-field input,
    .form-field textarea {
      transition:
        border-color 0.2s ease,
        box-shadow 0.2s ease;
    }
  }
</style>
