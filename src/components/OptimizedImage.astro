---
/**
 * OptimizedImage Component - Shared Image Component
 *
 * Purpose: Reusable component for responsive, optimized images with
 * multiple formats (AVIF, WebP, JPEG) and lazy loading.
 *
 * Self-contained: Handles all image optimization patterns used across
 * BlogCard and ProjectCard components.
 */

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  sizes?: string;
  loading?: "lazy" | "eager";
  class?: string;
  aspectRatio?: "video" | "square" | "portrait";
  formats?: ("avif" | "webp" | "jpg")[];
  widths?: number[];
}

const {
  src,
  alt,
  width = 1024,
  height = 576,
  sizes = "(max-width: 768px) 100vw, 50vw",
  loading = "lazy",
  class: className = "",
  aspectRatio = "video",
  formats = ["avif", "webp", "jpg"],
  widths = [640, 1024, 1920],
} = Astro.props;

// Generate aspect ratio classes
const aspectClasses: Record<typeof aspectRatio, string> = {
  video: "aspect-video",
  square: "aspect-square",
  portrait: "aspect-[3/4]",
};

// Generate srcset strings for each format
function generateSrcSet(format: string): string {
  return widths.map((w) => `${src}-${w}w.${format} ${w}w`).join(", ");
}
---

<picture>
  {
    formats.includes("avif") && (
      <source type="image/avif" srcset={generateSrcSet("avif")} sizes={sizes} />
    )
  }
  {
    formats.includes("webp") && (
      <source type="image/webp" srcset={generateSrcSet("webp")} sizes={sizes} />
    )
  }
  <img
    src={`${src}-${widths[1]}w.jpg`}
    alt={alt}
    loading={loading}
    decoding="async"
    width={width}
    height={height}
    class:list={[aspectClasses[aspectRatio], className]}
  />
</picture>
